<!DOCTYPE html>
<html>
<head>
<title>JavaScriptで画像を処理してみよう企画</title>
<meta charset="UTF-8">
<script>

var image = null;
function imload(){
	var files = document.getElementById("files").files;
	var isImage =  files[0].type==='image/jpeg' || files[0].type==='image/bmp' || files[0].type==='image/png' || files[0].type==='image/gif';
	if(files.length && isImage){
		var reader = new FileReader;
		reader.addEventListener('load', function(evt){
			var _src = evt.target.result;
			var cvs = document.querySelector('canvas');
			var ctx = cvs.getContext('2d');
			ctx.clearRect(0,0,400,300);
			image = new Image();
			image.src = _src;
			image.addEventListener('load',function(){
				ctx.drawImage(image,0,0,cvs.width,cvs.height);
			},false);
		}, false);
		reader.readAsDataURL(files[0]);
	}
}

function handler(evt){
	var files = evt.target.files;
	document.getElementById("file_detail").innerHTML = "'"+files[0].name+"' "+files[0].type+" "+files[0].size+"bytes";
}

window.onload = function(){
	document.getElementById("files").addEventListener('change', handler, false);
	document.getElementById("load_button").addEventListener('mousedown', imload, false);
	document.getElementById("apply_button").addEventListener('mousedown',function(){
		var none_proc = function(){
			var cvs = document.querySelector('canvas');
			var ctx = cvs.getContext('2d');
			ctx.drawImage(image,0,0,cvs.width,cvs.height);
		}
		var laplacian_proc = function(){
			var cvs = document.querySelector('canvas');
			var ctx = cvs.getContext('2d');
			grayscale();
			var inputData = ctx.getImageData(0, 0, cvs.width, cvs.height).data;
			
			var laplacian=[	2,0,2,
							0,-8,0,
							2,0,2];
			
			var output = ctx.createImageData(cvs.width, cvs.height);
			var outputData = output.data;
			
			for(var i = 1; i < cvs.height - 1; ++i ){
				for(var j = 1; j < cvs.width - 1; ++j ){
					var val = 0;
					for(var dy = -1; dy <= 1; ++dy){
						for(var dx = -1; dx <= 1; ++dx){
							val += inputData[ ((i + dy) * cvs.width + (j + dx)) * 4 + 0 ] * laplacian[ ( dy + 1 ) * 3 + dx + 1 ]
						}
					}
					outputData[(i * cvs.width + j) * 4 + 0] = val;
					outputData[(i * cvs.width + j) * 4 + 1] = val;
					outputData[(i * cvs.width + j) * 4 + 2] = val;
					outputData[(i * cvs.width + j) * 4 + 3] = 0xff;
				}
			}
			ctx.putImageData(output,0,0);
		}
		var dither = function(){
			var cvs = document.querySelector('canvas');
			var ctx = cvs.getContext('2d');
			ctx.drawImage(image,0,0,cvs.width,cvs.height);
			
			var inputData = ctx.getImageData(0, 0, cvs.width, cvs.height).data;
			
			var bayer =[0,8,2,10,
						12,4,14,6,
						3,11,1,9,
						15,7,13,5];
			
			var output = ctx.createImageData(cvs.width, cvs.height);
			var outputData = output.data;
			
			for(var i = 0; i < cvs.height; i += 4){
				for(var j = 0; j < cvs.width; j += 4){
					for(var dy = 0; dy < 4; ++dy ){
						for(var dx = 0; dx < 4; ++dx ){
							var r = inputData[((i + dy) * cvs.width + (j + dx)) * 4 + 0];
							var g = inputData[((i + dy) * cvs.width + (j + dx)) * 4 + 1];
							var b = inputData[((i + dy) * cvs.width + (j + dx)) * 4 + 2];
							var gray = (r+g+b)/3|0;
							if( gray >= bayer[ dy * 4 + dx ]*16 ){
								outputData[((i + dy) * cvs.width + (j + dx)) * 4 + 0] = 0xff;
								outputData[((i + dy) * cvs.width + (j + dx)) * 4 + 1] = 0xff;
								outputData[((i + dy) * cvs.width + (j + dx)) * 4 + 2] = 0xff;
								outputData[((i + dy) * cvs.width + (j + dx)) * 4 + 3] = 0xff;
							}else{
								outputData[((i + dy) * cvs.width + (j + dx)) * 4 + 0] = 0x00;
								outputData[((i + dy) * cvs.width + (j + dx)) * 4 + 1] = 0x00;
								outputData[((i + dy) * cvs.width + (j + dx)) * 4 + 2] = 0x00;
								outputData[((i + dy) * cvs.width + (j + dx)) * 4 + 3] = 0xff;
							}
						}
					}
				}
			}
			ctx.putImageData(output,0,0);
		}
		var grayscale = function(){
			var cvs = document.querySelector('canvas');
			var ctx = cvs.getContext('2d');
			ctx.drawImage(image,0,0,cvs.width,cvs.height);
			
			var inputData = ctx.getImageData(0, 0, cvs.width, cvs.height).data;
			
			var output = ctx.createImageData(cvs.width, cvs.height);
			var outputData = output.data;
			
			for(var i = 0; i < cvs.height; i += 4){
				for(var j = 0; j < cvs.width; j += 4){
					for(var dy = 0; dy < 4; ++dy ){
						for(var dx = 0; dx < 4; ++dx ){
							var r = inputData[((i + dy) * cvs.width + (j + dx)) * 4 + 0];
							var g = inputData[((i + dy) * cvs.width + (j + dx)) * 4 + 1];
							var b = inputData[((i + dy) * cvs.width + (j + dx)) * 4 + 2];
							var gray = (r+g+b)/3|0;
								outputData[((i + dy) * cvs.width + (j + dx)) * 4 + 0] = gray;
							outputData[((i + dy) * cvs.width + (j + dx)) * 4 + 1] = gray;
							outputData[((i + dy) * cvs.width + (j + dx)) * 4 + 2] = gray;
							outputData[((i + dy) * cvs.width + (j + dx)) * 4 + 3] = 0xff;
						}
					}
				}
			}
			ctx.putImageData(output,0,0);
		}
		switch(document.querySelector("select").selectedIndex){
			case 0:
				none_proc();
				break;
			case 1:
				grayscale();
				break;
			case 2:
				dither();
				break;
			case 3:
				laplacian_proc();
				break;
		}
	},false);
}
</script>
</head>
<body>
<div>
<input type="button" value="load" id="load_button">
<input type="file" id="files">
<output id="file_detail"></output>
</div>
<canvas width="400" height="300"></canvas><br>
<select>
<option>None</option>
<option>Grayscale</option>
<option>Dither</option>
<option>Laplacian</option>
</select>
<input type="button" value="Apply" id="apply_button">
</body>
</html>